rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // --- GLOBAL HELPERS ---

    function isSignedIn() {
      return request.auth != null;
    }

    // Safely checks for Admin status across all possible methods
    function isAdmin() {
      return isSignedIn() && (
        // 1. Check Custom Claim (Safe check for undefined)
        (request.auth.token.get('admin', false) == true) || 
        // 2. Check if it's the Google Reviewer account
        (request.auth.token.email == 'guest-admin@taxshila-auth.com') ||
        // 3. Fallback: Check if UID exists in the 'admins' collection
        exists(/databases/$(database)/documents/admins/$(request.auth.uid))
      );
    }

    // Identifies the Google Reviewer to block destructive actions
    function isReviewer() {
      return request.auth.token.email == 'guest-admin@taxshila-auth.com';
    }

    // --- COLLECTION RULES ---

    // Students Collection
    match /students/{studentDocId} {
      // Allow list for login queries by any user (unauthenticated included)
      allow list: if true; 
      // Allow a signed-in user to read their own document, or an admin to read any document
      allow read: if isAdmin() || (isSignedIn() && resource.data.uid == request.auth.uid);
      
      // Prevent reviewer from deleting or creating students, but allow real admins
      allow create: if isAdmin() && !isReviewer();
      allow update: if (isAdmin() || (isSignedIn() && resource.data.uid == request.auth.uid)) && !isReviewer();
      allow delete: if isAdmin() && !isReviewer();
    }

    // Admins Collection
    match /admins/{adminId} {
      // Allow list for login queries and admin management page
      allow list: if isAdmin();
      // Only allow admins to read admin documents
      allow read: if isAdmin();
      // Disallow client-side writes to the admins collection (managed by API routes)
      allow write: if false;
      allow delete: if isAdmin() && !isReviewer();
    }

    // Admin Notes Collection
    match /adminNotes/{noteId} {
      allow read: if isAdmin();
      allow create, update, delete: if isAdmin() && !isReviewer();
    }

    // Attendance & Feedback
    match /attendanceRecords/{id} {
      allow read: if isAdmin() || isSignedIn();
      allow create, update: if isSignedIn(); 
      allow delete: if isAdmin() && !isReviewer();
    }

    match /feedbackItems/{id} {
      allow create,read : if isSignedIn();
      allow update, delete: if isAdmin() && !isReviewer();
    }

    // App Configuration & Alerts
    match /appConfiguration/{id} {
      allow read: if isSignedIn();
      allow write: if isAdmin() && !isReviewer();
      allow delete: if isAdmin() && !isReviewer();
    }

    match /alertItems/{id} {
      allow read: if isSignedIn();
      allow write: if isAdmin() && !isReviewer();
      allow delete: if isAdmin() && !isReviewer();
    }
  }
}
